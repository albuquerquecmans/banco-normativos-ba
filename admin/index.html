<!doctype html>
<meta charset="utf-8">
<title>Admin · Banco de Normativos BA</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{--fg:#0f172a;--muted:#475569;--bg:#f8fafc;--card:#ffffff;--pri:#2563eb}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0;background:var(--bg);color:var(--fg)}
  .wrap{max-width:960px;margin:40px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid #e2e8f0;border-radius:16px;padding:24px;box-shadow:0 2px 6px rgba(0,0,0,.04);margin-bottom:22px}
  h1{font-size:1.6rem;margin:0 0 10px}
  h2{font-size:1.25rem;margin:0 0 12px}
  p{color:var(--muted);margin:0 0 14px}
  .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
  a.btn{display:inline-block;background:var(--pri);color:#fff;text-decoration:none;padding:12px 16px;border-radius:12px}
  a.btn.secondary{background:#0ea5e9}
  .hint{font-size:.92rem;color:var(--muted)}
  input{padding:10px;border:1px solid #cbd5e1;border-radius:10px;width:100%}
  label{display:block;font-weight:600;margin:8px 0 6px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .pill{background:#eef2ff;color:#1e293b;border-radius:999px;padding:4px 10px;font-size:.85rem}
  .warn{background:#fff7ed;border:1px solid #fdba74;color:#9a3412;border-radius:12px;padding:10px 12px;margin-top:10px}
</style>

<div class="wrap">
  <h1>Admin · Banco de Normativos de Benefícios Assistenciais</h1>

  <div class="card">
    <h2>Novo ato</h2>
    <p>Inclusões são feitas via <strong>Issue Form</strong>. Ao enviar, um workflow cria um PR com o patch; após o merge, o site atualiza.</p>
    <div class="actions">
      <a id="btnNovo" class="btn" target="_blank" rel="noreferrer">Abrir “Novo ato”</a>
      <span class="hint">Requer permissão para abrir issues.</span>
    </div>
  </div>

  <div class="card">
    <h2>Alterar ato existente</h2>
    <label for="busca">Buscar ato (identificação, número, tipo, ano…)</label>
    <input id="busca" list="atos" placeholder="ex: Portaria MDS nº 123, 2024 / Lei 8742" autocomplete="off">
    <datalist id="atos"></datalist>

    <div id="resumo" class="row" style="margin-top:10px;display:none">
      <span class="pill" id="pTipo"></span>
      <span class="pill" id="pNum"></span>
      <span class="pill" id="pAno"></span>
      <span class="pill" id="pSit"></span>
      <a id="linkVer" class="btn secondary" style="padding:6px 10px" target="_blank" rel="noreferrer">Ver no site</a>
    </div>

    <div class="actions" style="margin-top:14px">
      <a id="btnAlterar" class="btn" target="_blank" rel="noreferrer" aria-disabled="true">Abrir “Alterar ato”</a>
      <span class="hint">O título da issue incluirá o slug selecionado.</span>
    </div>

    <div id="warn" class="warn" style="display:none"></div>
  </div>

  <div class="card">
    <p><a href="../">← Voltar ao site</a></p>
  </div>
</div>

<script>
(function () {
  // Descobre owner/repo a partir do domínio de Pages; ajuste manual se usar domínio customizado
  const owner = (location.hostname.endsWith('github.io') ? location.hostname.split('.')[0] : 'albuquerquecmans');
  const repo  = (location.pathname.split('/').filter(Boolean)[0] || 'banco-normativos-ba');
  const issuesBase = `https://github.com/${owner}/${repo}/issues/new`;

  document.getElementById('btnNovo').href    = `${issuesBase}?template=novo_ato.yml`;
  document.getElementById('btnAlterar').href = `${issuesBase}?template=alterar_ato.yml`;

  // Resolve robustamente a URL do norms.json
  function resolveNormsUrls() {
    const root = `/${repo}`;
    const candidates = [
      `${root}/data/norms.json`, // pages padrão
      '../data/norms.json',      // relativo a /admin/
      '/data/norms.json'         // fallback
    ];
    return [...new Set(candidates)];
  }

  // Tenta carregar de múltiplas URLs até uma funcionar
  async function loadNorms() {
    const urls = resolveNormsUrls();
    let lastErr;
    for (const url of urls) {
      try {
        const r = await fetch(url, {cache: 'no-store'});
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        console.log('[admin] norms de', url, 'registros=', Array.isArray(data)?data.length:'?');
        return data;
      } catch (e) {
        console.warn('[admin] falhou', url, e);
        lastErr = e;
      }
    }
    throw lastErr || new Error('Falha ao carregar norms.json');
  }

  const busca = document.getElementById('busca');
  const datalist = document.getElementById('atos');
  const resumo = document.getElementById('resumo');
  const pTipo = document.getElementById('pTipo');
  const pNum  = document.getElementById('pNum');
  const pAno  = document.getElementById('pAno');
  const pSit  = document.getElementById('pSit');
  const linkVer = document.getElementById('linkVer');
  const btnAlterar = document.getElementById('btnAlterar');
  const warn = document.getElementById('warn');

  let atos = [];

  loadNorms().then(data => {
    atos = Array.isArray(data) ? data : [];
    if (!atos.length) {
      warn.style.display='block';
      warn.textContent = 'Nenhum ato encontrado em data/norms.json.';
      return;
    }
    const frag = document.createDocumentFragment();
    atos.forEach(n => {
      const idt = (n.identificacao || '').trim();
      const opt = document.createElement('option');
      opt.value = idt ? `${idt} (${n.slug})` : n.slug;
      frag.appendChild(opt);
    });
    datalist.appendChild(frag);
  }).catch(err => {
    warn.style.display='block';
    warn.innerHTML = 'Não foi possível carregar <code>data/norms.json</code>. Verifique se o arquivo está publicado. ' +
                     'Abra o console (F12) para detalhes.';
    console.error('[admin] erro ao carregar norms.json:', err);
  });

  function encontrarPorEntrada(txt) {
    if (!txt) return null;
    const m = txt.match(/\(([^)]+)\)\s*$/);
    const slug = m ? m[1] : null;
    if (slug) return atos.find(a => a.slug === slug) || null;
    const q = txt.toLowerCase();
    return atos.find(a =>
      (a.identificacao||'').toLowerCase().includes(q) ||
      (a.tipo||'').toLowerCase().includes(q) ||
      String(a.numero||'').toLowerCase().includes(q) ||
      String(a.ano||'').toLowerCase().includes(q) ||
      (a.slug||'').toLowerCase().includes(q)
    ) || null;
  }

  function atualizarResumo(n) {
    if (!n) { resumo.style.display='none'; btnAlterar.setAttribute('aria-disabled','true'); return; }
    pTipo.textContent = n.tipo || '—';
    pNum.textContent  = 'Nº ' + (n.numero ?? '—');
    pAno.textContent  = String(n.ano ?? '—');
    pSit.textContent  = n.situacao || (n.vigencia || '—');
    linkVer.href = n.slug ? `../${n.slug}.html` : '../';
    resumo.style.display='flex';

    const titulo = encodeURIComponent(`Alterar ato: ${n.slug}`);
    btnAlterar.href = `${issuesBase}?template=alterar_ato.yml&title=${titulo}`;
    btnAlterar.removeAttribute('aria-disabled');
  }

  busca.addEventListener('change', () => {
    const n = encontrarPorEntrada(busca.value);
    atualizarResumo(n);
  });
  busca.addEventListener('input', () => {
    resumo.style.display='none';
    btnAlterar.setAttribute('aria-disabled','true');
  });
})();
</script>
